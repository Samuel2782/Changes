import{e,a as s,d as t,g as n}from"./DataSyncService-BnTv72BN.js";import{u as r}from"./Logger-CErMjlBd.js";import{V as i}from"./index-DY0DW88M.js";var o=(e=>(e.User="user",e.Assistant="assistant",e))(o||{});class a{constructor({id:e=r(),content:s,role:t,createTime:n=(new Date).toISOString(),parentId:i}){this.id=e,this.content=s,this.role=t,this.createTime=n,this.parentId=i,this.key=s?s.slice(0,100):this.id}}class c extends a{constructor(e){super({...e,role:"user"}),this.role="user",this.regenerationIds=e.regenerationIds||[this.id]}}class h extends a{constructor(e){super({...e,role:"assistant"}),this.role="assistant",this.regenerating=!!e.regenerating}}class d{constructor(){this.id="processing",this.processing=!0,this.role="assistant",this.key="processing"}}class l{constructor(e){this.error=e,this.id="error",this.role="assistant",this.key="error"}}class v{constructor(e,{onRefresh:s,onUpdate:t,onDelete:n}){this.update=null,this.refresh=null,this.delete=null,s&&(this.refresh=new u(e+":refresh",s)),t&&(this.update=new u(e+":update",t)),n&&(this.delete=new u(e+":delete",n))}sendUpdate(e){if(!this.update)throw new Error("no update handler registered");this.update.sendEvent(e)}sendRefresh(e){if(!this.refresh)throw new Error("no refresh handler registered");this.refresh.sendEvent(e)}sendDelete(e){if(!this.delete)throw new Error("no delete handler registered");this.delete.sendEvent(e)}destroy(){this.update&&this.update.destroy(),this.refresh&&this.refresh.destroy()}}class u{constructor(s,t){this.eventHandlerId=s,this.eventHandler=t,e.addCrossTabMessageListener(this.eventHandlerId,t)}sendEvent(s){e.sendCrossTabMessage(this.eventHandlerId,s)}destroy(){e.removeCrossTabMessageListener(this.eventHandlerId,this.eventHandler)}}class g{constructor(){this.crossTabConversationListService=null,this.crossTabConversationService=null}async getConversations(e,t,n){this.crossTabConversationListService??(this.crossTabConversationListService=new v("chat:conversations",{onRefresh:e,onUpdate:t,onDelete:n}));const{data:r}=await s.get("ai/chat");this.crossTabConversationListService.sendRefresh(r),e(r)}async getConversation(e,t){this.crossTabConversationService&&this.crossTabConversationService.destroy(),this.crossTabConversationService=new v("chat:conversation:"+e,{onUpdate:t});const{data:n}=await s.get("ai/chat/"+e);t(n)}updateConversationTitle(e){var t;return null==(t=this.crossTabConversationListService)||t.sendUpdate([e]),s.patch(`/ai/conversation/${e.id}?update_mask=title`,{title:e.title})}deleteConversation(e){var t;return null==(t=this.crossTabConversationListService)||t.sendDelete(e),s.delete(`/ai/conversation/${e}`)}async sendMessage({content:e,parentId:t}){var n,r;const{data:i}=await s.post("ai/chat",{content:e,parentId:t});if(t)null==(r=this.crossTabConversationService)||r.sendUpdate([{content:e,parentId:t,id:i.id,role:o.User},i.response]);else{const s=(new Date).toISOString();null==(n=this.crossTabConversationListService)||n.sendUpdate([{title:e,id:i.id,createTime:s,updateTime:s}])}return i}async regenerate(e){var t;const{data:n}=await s.post("ai/chat",{parentId:e});return null==(t=this.crossTabConversationService)||t.sendUpdate([n.response]),n}}class p{constructor({id:e,title:s,createTime:t=(new Date).toISOString(),updateTime:n=t}){this.id=e,this.title=s,this.createTime=t,this.updateTime=n}serialize(){return{...this}}}const C=((e=(()=>({chatService:new g}))().chatService)=>t("chat",{state:()=>({processingContext:null,input:"",activeConversationMessages:{},activeConversationId:null,conversations:{},conversationsLoading:!1,conversationsLoaded:!1,conversationMessagesLoading:!1,selectedAnswer:null,messageError:null,fetchError:null}),getters:{activeConversation(e){const s=e.activeConversationId&&e.activeConversationId in e.conversations&&e.conversations[e.activeConversationId];return s?new p(s):null},conversationsSorted:e=>Object.values(e.conversations).sort(((e,s)=>new Date(s.updateTime||s.createTime).getTime()-new Date(e.updateTime||e.createTime).getTime())),processing:e=>!!e.processingContext,canSubmit(e){return!this.processing&&!e.messageError},chatRelationships(e){const s={};return Object.values(e.activeConversationMessages).forEach((({id:e,parentId:t})=>{if(t){const n=s[t];n?n.push(e):s[t]=[e]}})),s},rootMessage:e=>Object.values(e.activeConversationMessages).find((e=>!e.parentId)),chatMessages(){var e,s,t;if(!(null==(e=this.rootMessage)?void 0:e.id))return[];return function(e,s,t,n){const r=[];return function e(i){let a;if(i.role===o.User){const e={...i},t=s[i.id];t&&(e.regenerationIds=t),a=new c(e)}else{if(i.role!==o.Assistant)throw new Error("message has no valid role");a=new h({...i,...i.id===n?{regenerating:!0}:{}})}if(r.unshift(a),a.parentId){const s=t[a.parentId];s&&e(s)}}(e),r}(function(e,s,t){let n=t[e];if(!n)throw new Error(`startingMessage: ${e} not found in items`);return function e(r){const i=s[r];i&&i.forEach((s=>{const r=t[s];if(!r)throw new Error(`message: ${s} not found in items`);n||(n=r),r.createTime>n.createTime&&(n=r),e(r.id)}))}(e),n}(this.selectedAnswer||this.rootMessage.id,this.chatRelationships,this.activeConversationMessages),this.chatRelationships,this.activeConversationMessages,(null==(t=null==(s=this.processingContext)?void 0:s.regeneratingMessage)?void 0:t.id)??null)},lastAssistantMessage(){return this.chatMessages.findLast((e=>e.role===o.Assistant))},userMessageContent(e){var s,t,n;return(null==(n=null==(t=null==(s=e.messageError)?void 0:s.context)?void 0:t.userMessage)?void 0:n.content)??e.input}},actions:{refreshConversations(){if(this.fetchError=null,this.conversationsLoading)return;this.conversationsLoading=!0;const s=e=>{e.forEach((e=>{e.id&&i.set(this.conversations,e.id,e)})),this.conversationsLoading=!1,this.conversationsLoaded=!0};e.getConversations((e=>{Object.keys(this.conversations).forEach((e=>i.delete(this.conversations,e))),s(e)}),s,(e=>this.deleteConversationFromStore(e))).catch((e=>{this.conversationsLoading=!1,this.fetchError=n(e),this.fetchError.retry=this.refreshConversations.bind(this),console.error(e)}))},async selectConversation(s){if(s===this.activeConversationId)return;this.fetchError=null,this.conversationMessagesLoading=!0;const t={};this.activeConversationId=s,await e.getConversation(s,(e=>{e.forEach((e=>{e.id&&i.set(t,e.id,e)})),this.conversationMessagesLoading=!1,this.selectedAnswer=null,this.activeConversationMessages=t})).catch((e=>{this.conversationMessagesLoading=!1,this.activeConversationId=null,this.fetchError=n(e),this.fetchError.retry=this.selectConversation.bind(this,s),console.error(e)}))},async submit(){var s,t;const n=this.userMessageContent.trim();if(this.processing||!n)return!1;this.input="",this.messageError=null;const r={content:n},o=null==(s=this.lastAssistantMessage)?void 0:s.id;o&&(r.parentId=o);const a=new c(r),d=this.activeConversationId,l=this.processingContext={conversationId:d,userMessage:a};try{const{id:s,response:r,conversationId:c,conversationTitle:l}=await e.sendMessage({content:n,parentId:o,rootId:null==(t=this.rootMessage)?void 0:t.id});this.activeConversationId===d&&(a.id=s,i.set(this.activeConversationMessages,s,a),i.set(this.activeConversationMessages,r.id,new h({...r,parentId:s})),!this.activeConversationId&&c&&(this.activeConversationId=c)),d?this.updateConversationUpdateTime(d,r.createTime):c&&l&&i.set(this.conversations,c,new p({id:c,title:l})),this.selectedAnswer=null}catch(v){throw this.handleMessageError(v,l),v}finally{this.processingContext=null}return!0},async regenerate(s){const t=this.activeConversationId;if(this.processing||!t)return;if(this.messageError=null,!s.parentId)throw new Error('Last message "id" was not found');const n=this.processingContext={conversationId:t,regeneratingMessage:s};try{const{response:n}=await e.regenerate(s.parentId);this.activeConversationId===t&&i.set(this.activeConversationMessages,n.id,new h(n)),this.updateConversationUpdateTime(t,n.createTime),this.selectedAnswer=null}catch(r){throw this.handleMessageError(r,n),r}finally{this.processingContext=null}},handleMessageError(e,s){this.messageError={context:s,error:n(e)},console.error(e)},editLastMessage(){var e,s;const t=null==(s=null==(e=this.messageError)?void 0:e.context)?void 0:s.userMessage;t&&(this.input=t.content||"",this.messageError=null)},clear(){this.messageError=null,this.activeConversationMessages={},this.activeConversationId=null,this.selectedAnswer=null,this.input=""},async updateConversationTitle(s){const t=this.conversations[s.id];try{const n=s.serialize();if(!t)throw new Error("Conversation not found");n.updateTime=(new Date).toISOString(),i.set(this.conversations,s.id,n),await e.updateConversationTitle(n)}catch(n){throw console.error(n),i.set(this.conversations,s.id,t),n}},updateConversationUpdateTime(e,s){const t=this.conversations[e];t&&(t.updateTime=s)},deleteConversation(s){return this.deleteConversationFromStore(s),e.deleteConversation(s)},deleteConversationFromStore(e){i.delete(this.conversations,e),this.activeConversationId===e&&this.clear()}}}))();export{h as A,p as C,d as P,o as R,c as U,l as a,C as u};